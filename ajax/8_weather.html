<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/weather.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=779052ad52aa171e888adae6da6fbe97"></script>
    <title>Open Weather API 이용하기</title>
    <script>
        // da682723f3f3090676e3c74c221876e0
        let baseurl = `https://api.openweathermap.org/data/2.5/weather?appid=da682723f3f3090676e3c74c221876e0`;

        $(function(){
            getWeatherData("seoul", "metric"); // 서울, 섭씨단위
            // 유저가 선택한 도시의 날씨 출력
            // console.log($("#selectCity").val());
            $("#selectCity, input[name='unit']").change(function(){
            // $(".controller").on("change", "#selectCity, input[name='unit']", function(){}) // 윗줄대신 이것도 가능
                let city = $("#selectCity").val();
                let unit = $("input[name='unit']:checked").val();
                // console.log($("input[name='unit']:checked").val());
                // $.each($("input[name='unit'"), function(i, item){
                //     if(item.checked){
                //         unit = $(item).val();
                //     }
                // })
                
                getWeatherData(city, unit);
            })

            
        });

        function getWeatherData(cityName, unit){
            // https://api.openweathermap.org/data/2.5/weather?q=seoul&appid=da682723f3f3090676e3c74c221876e0&units=metric
            let url = baseurl +"&q=" + cityName + "&units=" + unit;
            $.ajax({
                url: url, // 데이터가 송수신될 서버의 주소
                type: "GET", // 통신 방식 (GET, POST, PUT, DELETE)
                dataType: "json", // 수신받을 데이터의 타입 (MIME TYPE)
                success: function(data){ // 통신이 성공하면 수행할 함수
                    console.log(data);
                    parsingJSON(data);
                },
                error: function(){},
                complete: function(){}
            });
        }

        function parsingJSON(json){
            let cityName = json.name;
            let description = json.weather[0].description;
            // console.log(json.name);
            // console.log(description);
            let mainWeather = json.main;
            // console.log(mainWeather);

            let iconDescription = `<img src="https://openweathermap.org/img/wn/${json.weather[0].icon}@2x.png">${description}`;

            let output = ""
            output += ``
            output += `<table><tr><th>기온</th><td>${mainWeather.temp}</td></tr>`;
            output += `<tr><th>체감온도</th><td>${mainWeather.feels_like}</td></tr>`;
            output += `<tr><th>최고기온</th><td>${mainWeather.temp_max}</td></tr>`;
            output += `<tr><th>최저기온</th><td>${mainWeather.temp_min}</td></tr>`;
            output += `<tr><th>습도</th><td>${mainWeather.humidity}</td></tr>`;
            output += `<tr><th>기압</th><td>${mainWeather.pressure}</td></tr>`;
            output += `<table>`;

            $("#cityName").html(cityName);
            $(".weatherInfo__weather").html(iconDescription);
            $(".weatherInfo__mainWeather").html(output);
            
            // 날씨아이콘 마커의 카카오지도를 추가해보자.
            outputMap(json);
        }

        function outputMap(json){
            $("#map").empty();
            let lat = json.coord.lat;
            let lon = json.coord.lon;

            var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
                mapOption = { 
                    center: new kakao.maps.LatLng(lat, lon), // 지도의 중심좌표
                    level: 10 // 지도의 확대 레벨
                };

            var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다

            var imageSrc = `https://openweathermap.org/img/wn/${json.weather[0].icon}@2x.png`, // 마커이미지의 주소입니다    
                imageSize = new kakao.maps.Size(64, 69), // 마커이미지의 크기입니다
                imageOption = {offset: new kakao.maps.Point(27, 69)}; // 마커이미지의 옵션입니다. 마커의 좌표와 일치시킬 이미지 안에서의 좌표를 설정합니다.
                
            // 마커의 이미지정보를 가지고 있는 마커이미지를 생성합니다
            var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption),
                markerPosition = new kakao.maps.LatLng(lat, lon); // 마커가 표시될 위치입니다

            // 마커를 생성합니다
            var marker = new kakao.maps.Marker({
                position: markerPosition, 
                image: markerImage // 마커이미지 설정 
            });

            // 마커가 지도 위에 표시되도록 설정합니다
            marker.setMap(map);
        }
    </script>
    <style>
        
    </style>
</head>
<body>
    <div class="container">
        <h1><span id="cityName"></span>의 날씨</h1>
        <div class="controller">
            <!-- 도시이름선택 -->
            <select id="selectCity" class="form-select">
                <option value="seoul">서울</option>
                <option value="daejeon">대전</option>
                <option value="busan">부산</option>
                <option value="jeju">제주</option>
                <option value="incheon">인천</option>
            </select>
            <!-- 단위선택 -->
            <div class="selectUnits">
                <label class="form-check-label" for="cel">
                    <input type="radio" class="form-check-input" id="cel" name="unit" value="metric" checked>
                    <img src="images/celsius.png" alt="" >
                </label>
                
                <label class="form-check-label" for="fah">
                    <input type="radio" class="form-check-input" id="fah" name="unit" value="imperial" >
                    <img src="images/fahrenheit.png" alt="" >
                </label>
                
                <label class="form-check-label" for="kel">
                    <input type="radio" class="form-check-input" id="kel" name="unit" value="default" >
                    <img src="images/kelvin.png" alt="" >
                </label>
                
            </div>
        </div>
        <div class="contents">
            <!-- description -->
            <div class="weatherInfo__weather"></div>
            <!-- main (table태그)-->
            <div class="weatherInfo__mainWeather"></div>
        </div>

        <div id="map" style="width:100%;height:350px;"></div>
    </div>
</body>
</html>